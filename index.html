<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>花蓮愛心計程車 (IoT)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f3f4f6;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior-y: none; /* 防止下拉刷新干擾 */
    }
    .btn-main {
      transition: all 0.2s;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .btn-main:active { transform: scale(0.95); }
    .btn-main:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
    
    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.9);
      z-index: 50; /* 低於黑屏 */
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .spinner {
      width: 50px; height: 50px;
      border: 5px solid #e5e7eb; border-top: 5px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* 上下班 Toggle Switch */
    .toggle-checkbox:checked {
      right: 0;
      border-color: #22c55e;
    }
    .toggle-checkbox:checked + .toggle-label {
      background-color: #22c55e;
    }
    
    /* 螢幕保護黑屏 */
    #screen-saver {
      display: none;
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: #000000;
      z-index: 9999; /* 最高層級 */
      flex-direction: column; justify-content: center; align-items: center;
      color: #333; /* 極暗字體 */
    }
    #saver-clock { font-size: 5rem; font-weight: bold; font-family: monospace; color: #444; }
    #saver-status { margin-top: 20px; font-size: 1rem; color: #22c55e; display: flex; align-items: center; }
    .dot-flash { width: 10px; height: 10px; background-color: #22c55e; border-radius: 50%; display: inline-block; margin-right: 8px; animation: flash 2s infinite; }
    @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
    #unlock-hint { position: absolute; bottom: 50px; color: #333; font-size: 0.9rem; }

    /* SweetAlert2 Form Styles */
    .swal2-input, .swal2-select {
        margin: 0.5em auto !important;
        width: 100% !important;
        font-size: 1rem !important;
    }
    .form-group { text-align: left; margin-bottom: 10px; }
    .form-label { font-size: 0.9rem; color: #666; font-weight: bold; margin-bottom: 4px; display: block; }
  </style>
</head>
<body class="pb-20">

  <div id="loading-overlay">
    <div class="spinner mb-4"></div>
    <div id="loading-text" class="text-gray-600 font-medium">連線中...</div>
  </div>

  <!-- Screen Saver (黑屏) -->
  <div id="screen-saver" onclick="unlockScreen()">
    <div id="saver-clock">--:--</div>
    <div id="saver-status">
       <span class="dot-flash"></span> GPS 回報中
    </div>
    <div id="unlock-hint">長按 2 秒解鎖</div>
  </div>

  <!-- Header -->
  <div class="bg-white shadow-sm sticky top-0 z-40">
    <div class="px-4 py-3 flex justify-between items-center">
      <div class="flex items-center">
        <h1 class="text-lg font-bold text-gray-800 mr-3">花蓮愛心計程車</h1>
        
        <!-- Toggle Switch -->
        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
            <input type="checkbox" name="toggle" id="work-status-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 left-0 transition-all duration-300" onclick="handleStatusToggle(this)"/>
            <label for="work-status-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
        </div>
        <span id="work-status-text" class="text-xs font-bold text-gray-400">下班</span>
      </div>
      
      <div class="text-right">
        <div class="text-xs text-gray-500">本月序號</div>
        <div id="global-seq" class="text-2xl font-black text-blue-600 font-mono">--</div>
      </div>
    </div>
  </div>

  <div class="container mx-auto px-4 mt-4 max-w-md">

    <!-- Last Record Area -->
    <div id="last-record-container" class="mb-6 hidden">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center">
             <i class="fas fa-history text-slate-500 mr-2"></i>
             <span class="text-sm font-bold text-slate-600">最後一筆記錄</span>
        </div>
        <div id="lr-seq-badge" class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded-full border border-blue-200">#--</div>
      </div>
      <div class="p-4 shadow-lg rounded-xl bg-slate-800 text-white relative overflow-hidden">
        <i class="fas fa-check-circle absolute -right-4 -bottom-4 text-6xl text-white opacity-5"></i>
        <div class="grid grid-cols-2 gap-3">
          <div><div class="text-xs text-slate-400">時間</div><div id="lr-time" class="text-lg font-bold">--:--</div></div>
          <div><div class="text-xs text-slate-400">卡別</div><div id="lr-type" class="text-lg font-bold text-yellow-400">--</div></div>
          <div class="col-span-2 border-t border-slate-600 my-1 pt-2">
            <div class="text-xs text-slate-400">行程</div>
            <div class="flex items-center mt-1">
              <span id="lr-pickup" class="font-bold">--</span>
              <i class="fas fa-arrow-right mx-2 text-slate-400 text-sm"></i>
              <span id="lr-dropoff" class="font-bold text-green-300">--</span>
            </div>
            <div id="lr-remarks-container" class="hidden mt-1 text-xs text-gray-400"><i class="fas fa-map-pin mr-1"></i> <span id="lr-remarks"></span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Action Area -->
    <div id="action-area" class="grid gap-4">
      <div id="idle-controls">
        <button id="btn-pickup" onclick="handlePickup()" disabled class="btn-main w-full bg-blue-600 hover:bg-blue-700 text-white rounded-2xl py-8 flex flex-col items-center justify-center disabled:bg-gray-400">
          <i class="fas fa-map-marker-alt text-4xl mb-2"></i>
          <span class="text-2xl font-bold">乘客上車</span>
          <span id="pickup-subtext" class="text-sm opacity-80 mt-1">請先切換為「上班」</span>
        </button>
      </div>

      <div id="driving-controls" class="hidden space-y-4">
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 text-center mb-2">
           <div class="text-sm text-blue-600 mb-1">正在前往</div>
           <div id="current-pickup-loc" class="text-xl font-bold text-gray-800">--</div>
        </div>
        <button onclick="handleDropoff('敬老卡')" class="btn-main w-full bg-green-600 hover:bg-green-700 text-white rounded-xl py-5 flex items-center justify-between px-8">
          <div class="flex items-center"><i class="fas fa-user-clock text-2xl mr-4"></i><div class="text-left"><div class="text-xl font-bold">敬老卡 下車</div><div class="text-xs opacity-80">一般老人 65歲以上</div></div></div><i class="fas fa-chevron-right"></i>
        </button>
        <button onclick="handleDropoff('愛心卡')" class="btn-main w-full bg-rose-500 hover:bg-rose-600 text-white rounded-xl py-5 flex items-center justify-between px-8">
          <div class="flex items-center"><i class="fas fa-heart text-2xl mr-4"></i><div class="text-left"><div class="text-xl font-bold">愛心卡 下車</div><div class="text-xs opacity-80">身心障礙者</div></div></div><i class="fas fa-chevron-right"></i>
        </button>
        <button onclick="handleStopover()" class="btn-main w-full bg-slate-600 hover:bg-slate-700 text-white rounded-xl py-4 flex items-center justify-center">
           <i class="fas fa-pause-circle mr-2"></i><span>記錄中途停靠</span>
        </button>
        <div class="text-center mt-4"><button onclick="handleDelete()" class="text-gray-400 underline text-sm py-2">乘客未搭乘 (刪除此筆)</button></div>
      </div>
    </div>
    
    <!-- Tools -->
    <div class="mt-8 grid grid-cols-2 gap-3">
        <a id="sheet-link" href="#" target="_blank" class="bg-white border border-gray-300 text-gray-700 py-3 rounded-lg text-center shadow-sm font-medium text-sm flex items-center justify-center"><i class="fas fa-table mr-2 text-green-600"></i>開啟報表</a>
        <button onclick="openToolsModal()" class="bg-white border border-gray-300 text-gray-700 py-3 rounded-lg text-center shadow-sm font-medium text-sm flex items-center justify-center"><i class="fas fa-tools mr-2 text-orange-500"></i>補單 / 刪除</button>
    </div>
    
    <div class="mt-8 text-center text-xs text-gray-400">System v20.7.2 | Logic: Auto-Busy/Online Switch</div>
  </div>

  <!-- Screen Saver FAB -->
  <button id="fab-saver" onclick="activateScreenSaver()" class="hidden fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 text-white rounded-full shadow-lg flex items-center justify-center text-xl z-30 active:scale-90 transition-transform">
    <i class="fas fa-moon"></i>
  </button>

  <script>
    let state = {
        row: 0,
        isDriving: false,
        pickupAddress: '',
        lastCompletedData: null,
        isOnline: false, // 上下班開關
        currentStatus: '下班', // 實際文字狀態: 空車, 載客中, 下班
        gpsIntervalId: null,
        wakeLock: null
    };

    window.onload = function() { initSystem(); };

    function initSystem() {
        showLoading('同步資料中...');
        google.script.run
            .withSuccessHandler(onInitSuccess)
            .withFailureHandler(onFailure)
            .getPreviewData();
    }

    function onInitSuccess(response) {
        hideLoading();
        if (!response.success) {
            Swal.fire('錯誤', response.error, 'error');
            return;
        }
        
        state.row = response.nextRow;
        state.isDriving = response.isDriving;
        state.lastCompletedData = response.lastCompleted;
        document.getElementById('global-seq').innerText = response.globalSeq;
        document.getElementById('sheet-link').href = response.spreadsheetUrl;

        if (response.lastCompleted) {
            updateLastRecordCard(response.lastCompleted);
        }

        // --- 狀態初始化邏輯 ---
        const toggle = document.getElementById('work-status-toggle');
        const dbStatus = response.driverStatus || '下班';
        state.currentStatus = dbStatus;
        
        // 只要不是「下班」，UI Toggle 就應該是開著的 (包含「空車」和「載客中」)
        const isOnline = (dbStatus !== '下班');
        toggle.checked = isOnline;
        updateStatusUI(isOnline, dbStatus);
        
        // 恢復行駛狀態
        if (state.isDriving) {
            setDrivingMode(true);
            if (response.lastRecord) {
                document.getElementById('current-pickup-loc').innerText = response.lastRecord.pickup;
                state.pickupAddress = response.lastRecord.pickup;
                state.row = response.activeRow;
            }
            // 如果系統發現正在開車，但資料庫狀態卻是「空車」，強制同步為「載客中」
            if (dbStatus === '空車') {
                updateStatusBySystem('載客中');
            }
        } else {
            setDrivingMode(false);
            // 如果系統發現沒在開車，但狀態是「載客中」，強制同步為「空車」
            if (dbStatus === '載客中') {
                updateStatusBySystem('空車');
            }
        }
    }

    // --- 系統自動切換狀態 (不觸發 Toggle 動畫，只改狀態) ---
    function updateStatusBySystem(newStatus) {
        console.log('System updating status to:', newStatus);
        state.currentStatus = newStatus;
        // 寫入後端
        google.script.run.updateDriverStatus(newStatus);
        // 更新 UI (保持 Toggle 開啟)
        updateStatusUI(true, newStatus);
    }

    // --- 使用者手動切換 Toggle ---
    function handleStatusToggle(checkbox) {
        const isChecked = checkbox.checked;
        
        if (isChecked) {
            // 手動開啟 -> 預設為 "空車" (上班)
            updateStatusBySystem('空車');
        } else {
            // 手動關閉 -> "下班"
            state.currentStatus = '下班';
            google.script.run.updateDriverStatus('下班');
            updateStatusUI(false, '下班');
        }
    }

    // --- 統一 UI 狀態更新 ---
    function updateStatusUI(isOnline, statusText) {
        state.isOnline = isOnline;
        const toggle = document.getElementById('work-status-toggle');
        const textEl = document.getElementById('work-status-text');
        const btnPickup = document.getElementById('btn-pickup');
        const pickupSub = document.getElementById('pickup-subtext');
        const fabSaver = document.getElementById('fab-saver');

        // 確保 Toggle 狀態同步
        toggle.checked = isOnline;

        if (isOnline) {
            // 上班模式 (空車 or 載客中)
            if (statusText === '載客中') {
                textEl.innerText = '載客中 (不接單)';
                textEl.className = 'text-xs font-bold text-orange-500'; // 橘色
            } else {
                textEl.innerText = '上班中 (空車)';
                textEl.className = 'text-xs font-bold text-green-600'; // 綠色
            }

            btnPickup.disabled = false;
            pickupSub.innerText = '記錄 GPS 與開始時間';
            fabSaver.classList.remove('hidden');
            startGpsHeartbeat();

        } else {
            // 下班模式
            textEl.innerText = '下班 (休息)';
            textEl.className = 'text-xs font-bold text-gray-400'; // 灰色
            
            btnPickup.disabled = true;
            pickupSub.innerText = '請先切換為「上班」';
            fabSaver.classList.add('hidden');
            stopGpsHeartbeat();
        }
    }

    // --- GPS Heartbeat ---
    function startGpsHeartbeat() {
        if (state.gpsIntervalId) return;
        console.log('GPS Heartbeat Started');
        sendHeartbeat();
        state.gpsIntervalId = setInterval(sendHeartbeat, 60000);
    }

    function stopGpsHeartbeat() {
        if (state.gpsIntervalId) {
            clearInterval(state.gpsIntervalId);
            state.gpsIntervalId = null;
            console.log('GPS Heartbeat Stopped');
        }
    }

    function sendHeartbeat() {
        if (!navigator.geolocation) return;
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                // 注意：這裡只更新座標，不改狀態
                google.script.run.updateDriverLocation(lat, lng);
            },
            (err) => { console.error('GPS Error', err); },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }

    // --- Action Handlers ---
    function handlePickup() {
        showLoading('定位中...');
        getLocation(
            (lat, lng) => performAction('pickup', { lat, lng }),
            () => performAction('pickup', { address: 'GPS定位失敗' })
        );
    }

    function handleDropoff(type) {
        Swal.fire({
            title: `確認${type}下車？`, text: "系統將記錄地點與時間", icon: 'question',
            showCancelButton: true, confirmButtonText: '確定', cancelButtonText: '取消',
            confirmButtonColor: '#3085d6', cancelButtonColor: '#d33'
        }).then((result) => {
            if (result.isConfirmed) {
                showLoading('結算中...');
                getLocation(
                    (lat, lng) => performAction('dropoff', { lat, lng, passengerType: type }),
                    () => performAction('dropoff', { address: 'GPS定位失敗', passengerType: type })
                );
            }
        });
    }

    function performAction(actionType, data) {
        let targetRow = (data && data.row) ? data.row : state.row;
        const payload = { row: targetRow, action: actionType, ...data };
        google.script.run.withSuccessHandler((res) => handleActionSuccess(res, actionType, data)).withFailureHandler(onFailure).handleRecord(payload);
    }

    function handleActionSuccess(res, actionType, reqData) {
        hideLoading();
        if (!res.success) { Swal.fire('錯誤', res.error, 'error'); return; }

        if (actionType === 'pickup') {
            document.getElementById('current-pickup-loc').innerText = res.pickupAddress;
            state.pickupAddress = res.pickupAddress;
            setDrivingMode(true);
            
            // ★ 自動切換為「載客中」 (Dispatch Offline)
            updateStatusBySystem('載客中');

            Swal.fire({ icon: 'success', title: '上車已記錄', text: res.pickupAddress, timer: 1500, showConfirmButton: false });
        } 
        else if (actionType === 'dropoff') {
            setDrivingMode(false);
            if (res.completedRecord) {
                updateLastRecordCard(res.completedRecord);
                state.lastCompletedData = res.completedRecord;
                state.row += 1;
                document.getElementById('global-seq').innerText = res.completedRecord.seq + 1;
            }

            // ★ 自動切換為「空車」 (Dispatch Online)
            updateStatusBySystem('空車');

            Swal.fire({ icon: 'success', title: '行程完成', text: `時間：${res.completedRecord.time}`, timer: 2000, showConfirmButton: false });
        } 
        else if (actionType === 'delete') {
            setDrivingMode(false);
            // 如果刪除行程，也應該恢復為「空車」
            updateStatusBySystem('空車');
            
            Swal.fire('已刪除', '行程已取消', 'success');
            if(res.updatedLastRecord) {
                updateLastRecordCard(res.updatedLastRecord);
                state.lastCompletedData = res.updatedLastRecord;
                state.row -= 1;
            } else {
                document.getElementById('last-record-container').classList.add('hidden');
                document.getElementById('global-seq').innerText = 1;
                state.row = 4;
            }
        } 
        else if (actionType === 'stopover') {
            Swal.fire('停靠記錄', res.message, 'success');
        } 
        else if (actionType === 'manual_insert') {
            Swal.fire('補單成功', '資料已寫入', 'success');
            setTimeout(initSystem, 1000);
        }
    }
    
    // --- (其他輔助函式保持不變) ---
    function handleStopover() {
        showLoading('記錄停靠點...');
        getLocation(
            (lat, lng) => performAction('stopover', { lat, lng }),
            () => Swal.fire('定位失敗', '無法取得GPS', 'error')
        );
    }
    function handleDelete() {
        Swal.fire({
             title: '確定取消此行程？', text: "這將會清除上車記錄", icon: 'warning',
             showCancelButton: true, confirmButtonText: '刪除', cancelButtonText: '保留', confirmButtonColor: '#d33'
        }).then((result) => {
             if (result.isConfirmed) {
                 showLoading('刪除中...');
                 performAction('delete', { row: state.row });
             }
        });
    }
    function getLocation(successCb, errorCb) {
        if (!navigator.geolocation) { if(errorCb) errorCb(); return; }
        navigator.geolocation.getCurrentPosition((pos) => successCb(pos.coords.latitude, pos.coords.longitude), (err) => { console.error("GPS Error", err); if(errorCb) errorCb(); }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
    }
    
    // Last Record UI
    function updateLastRecordCard(record) {
        document.getElementById('last-record-container').classList.remove('hidden');
        document.getElementById('lr-time').innerText = record.time || '--:--';
        document.getElementById('lr-type').innerText = record.type || '未填';
        document.getElementById('lr-pickup').innerText = record.pickup || '??';
        document.getElementById('lr-dropoff').innerText = record.dropoff || '??';
        if (record.seq) document.getElementById('lr-seq-badge').innerText = '#' + record.seq;
        const typeEl = document.getElementById('lr-type');
        typeEl.className = (record.type === '愛心卡') ? 'text-lg font-bold text-rose-400' : 'text-lg font-bold text-yellow-400';
        const remarkEl = document.getElementById('lr-remarks-container');
        if (record.remarks) {
            remarkEl.classList.remove('hidden');
            document.getElementById('lr-remarks').innerText = record.remarks;
        } else {
            remarkEl.classList.add('hidden');
        }
    }

    function setDrivingMode(isDriving) {
        state.isDriving = isDriving;
        const idleEl = document.getElementById('idle-controls');
        const driveEl = document.getElementById('driving-controls');
        if (isDriving) {
            idleEl.classList.add('hidden');
            driveEl.classList.remove('hidden');
        } else {
            idleEl.classList.remove('hidden');
            driveEl.classList.add('hidden');
        }
    }

    // Tools
    function openToolsModal() {
       Swal.fire({
            title: '工具箱', showCancelButton: true, showDenyButton: true, confirmButtonText: '<i class="fas fa-pen"></i> 手動補單', denyButtonText: '<i class="fas fa-trash-alt"></i> 刪除資料', cancelButtonText: '取消', confirmButtonColor: '#3085d6', denyButtonColor: '#d33', reverseButtons: true
       }).then((result) => {
            if (result.isConfirmed) openManualInsertModal();
            else if (result.isDenied) openManualDeleteModal();
       });
    }
    function openManualDeleteModal() {
        const defaultSeq = (state.lastCompletedData && state.lastCompletedData.seq) ? state.lastCompletedData.seq : '';
        Swal.fire({
            title: '刪除資料',
            html: `輸入序號刪除 (例如: ${defaultSeq || 39})`,
            input: 'number', inputValue: defaultSeq,
            showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: '刪除'
        }).then((result) => {
            if(result.isConfirmed && result.value) {
                showLoading(`正在刪除 #${result.value}...`);
                performAction('delete_by_seq', { seq: parseInt(result.value) });
            }
        });
    }
    function openManualInsertModal() {
        const now = new Date();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');
        const defaultTime = `${month}/${day} ${hour}:${minute}`;

        Swal.fire({
            title: '手動補單',
            html: `
                <div class="form-group">
                    <label class="form-label">時間 (月/日 時:分)</label>
                    <input id="m-time" class="swal2-input" value="${defaultTime}">
                </div>
                <div class="form-group">
                    <label class="form-label">卡別</label>
                    <select id="m-type" class="swal2-select">
                        <option value="敬老卡">敬老卡</option>
                        <option value="愛心卡">愛心卡</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">上車地點</label>
                    <input id="m-pickup" class="swal2-input" placeholder="例如: 門諾醫院">
                </div>
                <div class="form-group">
                    <label class="form-label">下車地點</label>
                    <input id="m-dropoff" class="swal2-input" placeholder="例如: 花蓮火車站">
                </div>
                <div class="form-group">
                    <label class="form-label">中途停靠 (選填)</label>
                    <input id="m-remarks" class="swal2-input" placeholder="例如: 全聯">
                </div>
            `,
            confirmButtonText: '送出補單',
            showCancelButton: true,
            preConfirm: () => {
                return {
                    customTime: document.getElementById('m-time').value,
                    passengerType: document.getElementById('m-type').value,
                    pickup: document.getElementById('m-pickup').value,
                    dropoff: document.getElementById('m-dropoff').value,
                    remarks: document.getElementById('m-remarks').value
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const data = result.value;
                if(!data.customTime || !data.pickup || !data.dropoff) {
                    Swal.fire('欄位未填', '時間、上車、下車地點為必填', 'warning');
                    return;
                }
                showLoading('補單寫入中...');
                performAction('manual_insert', data);
            }
        });
    }

    // Screen Saver / Wake Lock
    async function activateScreenSaver() {
        const saver = document.getElementById('screen-saver');
        saver.style.display = 'flex';
        updateSaverClock();
        state.clockInterval = setInterval(updateSaverClock, 1000);
        try {
            if ('wakeLock' in navigator) {
                state.wakeLock = await navigator.wakeLock.request('screen');
                state.wakeLock.addEventListener('release', () => { console.log('Wake Lock released'); });
            }
        } catch (err) { console.error(`${err.name}, ${err.message}`); }
    }
    let unlockTimer = null;
    function unlockScreen() {}
    const saverDiv = document.getElementById('screen-saver');
    saverDiv.addEventListener('touchstart', (e) => {
        document.getElementById('unlock-hint').innerText = '解鎖中...';
        document.getElementById('unlock-hint').style.color = '#22c55e';
        unlockTimer = setTimeout(() => { exitScreenSaver(); }, 1200);
    });
    saverDiv.addEventListener('touchend', () => {
        clearTimeout(unlockTimer);
        document.getElementById('unlock-hint').innerText = '長按 2 秒解鎖';
        document.getElementById('unlock-hint').style.color = '#333';
    });
    function exitScreenSaver() {
        document.getElementById('screen-saver').style.display = 'none';
        if (state.clockInterval) clearInterval(state.clockInterval);
        if (state.wakeLock !== null) { state.wakeLock.release().then(() => { state.wakeLock = null; }); }
    }
    function updateSaverClock() {
        const now = new Date();
        const h = String(now.getHours()).padStart(2, '0');
        const m = String(now.getMinutes()).padStart(2, '0');
        document.getElementById('saver-clock').innerText = `${h}:${m}`;
    }

    function showLoading(text) { document.getElementById('loading-text').innerText = text; document.getElementById('loading-overlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; }
    function onFailure(e) { hideLoading(); Swal.fire('系統錯誤', e.message, 'error'); }

  </script>
</body>
</html>